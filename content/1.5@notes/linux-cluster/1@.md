---
title: Linux Cluster(Part 1)
description: 集群概念、LVS、高可用负载均衡
---

## 概述

本文是观看[此视频](https://www.bilibili.com/video/BV1Db411G7pf)时的笔记

## 集群

### 概念

集群是一组协同工作的服务器，对外表现为一个整体

### 集群分类

- LBC(Load balancing cluster)负载均衡集群
  - 调度器后面的每个节点的任务相同，分担业务压力
- HAC(High availability cluster)高可用集群
  - backup使用心跳来检测master是否存活。如果backup意外成为master之后发现原master还存活，backup可能会把原master给kill掉
- HPC(High performance cluster)高性能计算集群
  - 分布式计算，调度器后面的每个节点的任务不同

## 负载均衡集群

### 概述

- 软件方案，成本低
  - **LVS**
  - Nginx
  - HAProxy
- 硬件方案，性能高
  - F5

负载均衡层级（越上层越智能，因为底层包的结构都会被解出来，同时也越慢）：

- 2层（数据链路层）
  - 实现方式：F5
  - 比如游戏服务器针对不同的运营商有不同的专线优化带宽，在2层实现链路分配
- 4层（传输层）
  - 实现方式：LVS、F5
  - 仅进行地址重写，不实现其他的解包操作。负载均衡器只是把请求的目标地址改为真实服务器地址，然后把响应的源地址改为自身地址
  - **只有一次TCP连接**
- 7层（应用层）
  - 实现方式：Nginx
  - 【客户端到负载均衡器】与【负载均衡器到服务器】是**两个TCP连接**
  - 负载均衡器会像服务器发起自己的请求，请求的源地址为负载均衡器的地址

负载均衡器在负载均衡集群里面压力最大，需要高可用

### LVS

> Linux Virtual Server

#### 概述

LVS可以分为两个部分：

- `ipvs`
  - 运行在内核空间
  - LVS的核心组件，集成在Linux的内核里面，不需要安装
- `ipvsadm`
  - 运行在用户空间
  - 用来控制内核空间的`ipvs`

#### 运行模式

- NAT
  - 拥有一个公网地址，一个私网地址
  - 用户->公网->负载均衡器(DNAT)->私网交换机->服务器->私网交换机->负载均衡器(SNAT)->公网->用户
  - 要求：服务器的网关设置为负载均衡器，因为服务器返回响应包的时候，目标地址为用户地址，但是要把包发给负载均衡器
  - 需要经过两次负载均衡器，负载较大
  - 支持端口映射
- TUN（隧道模式）
  - 负载均衡器只需要公网地址
  - 用户->公网->负载均衡器->公网->服务器->公网->用户
  - 适用场景：服务器散布在全球各地。不常用
  - 要求：
    - 负载均衡器转发的时候需要再加一层包头
    - 服务器需要解一层包头
  - 不支持端口映射
  - 因为使用隧道需要二次封包，所以压力也挺大
- DR
  - 负载均衡器只需要私网地址
  - 用户->公网->服务端路由器->私网交换机->负载均衡器->私网交换机->服务器->私网交换机->路由器->公网->用户
  - 只需要经过一次负载均衡器，负载量最高，最常用
  - 要求：
    - 负载均衡器使用MAC地址把包转发给服务器，即修改DMAC，而不是重写IP地址（因为响应不经过负载均衡器，所以如果负载均衡器改了地址，没有机会把地址改回来）
    - 负载均衡器和服务器在同一个网络，因为需要使用MAC地址通信
    - 服务器为了接收负载均衡器转发的包，需要设置一个隐性IP地址（和负载均衡器的IP相同），此地址仅对本机可见。通过设置ARP实现
    - 服务器建议是linux，这样才能设置隐性IP地址。如果服务器是windows，需要在路由器设置IP与MAC的绑定
  - 不支持端口映射（因为请求和响应不对称，如果映射了，没有机会改回来）

#### 连接分类与调度算法

HTTP连接的分类

- 活动连接
  - 已经握手且正在传输数据
  - 在动态调度算法中，活动连接视为256倍的非活动连接
- 非活动连接
  - 刚握手，还没有传输数据
  - 数据传输完毕，连接还没断开

调度算法：

- 静态调度算法
  - RR(Round Robin) - 轮询算法（默认）
  - WRR - 加权轮询
  - SH(source hash) - 源地址散列，同一个IP的请求发给同一个服务器。可以实现粘性会话
  - DH(destination hash) - 目标地址散列。基于路径路由。提升缓存命中率
- 动态调度算法（需要考虑服务器状态）
  - LC(Least Connection) - 最少连接数
    - 即选择`活动连接 * 256 + 非活动连接`最小的服务器
  - WLC - 加权最少链接
    - 即选择`(活动连接 * 256 + 非活动连接) / 权重`最小的服务器
  - SED - 最短期望延迟。是特殊的WLC
    - 即选择`(活动连接 + 1) * 256 / 权重`最小的服务器
    - 所有服务器活动连接相等的时候，会选择权重最大的服务器
  - NQ - 永不排队。在SED的基础上，如果有服务器连接数为0则直接分配
  - LBLC - 特殊的DH。某个目标地址压力过大时添加新的服务器，然后轮询。即考虑缓存命中率的基础上考虑服务器性能
  - LBLCR - 是LBLC+缓存。多个缓存服务器可以同步数据。是尽可能提高负载均衡和缓存命中率的折中方案

##### 持久连接

LVS支持持久连接，**且持久连接的优先级高于调度算法**

分类：

- PCC（持久客户端连接）
  - 类似与SH。一段时间内同一客户端的请求路由到相同的服务器
- PPC（持久端口连接）
  - 一段时间内同一个客户端对同一个端口的请求路由到相同的服务器
- PFMC（持久防火墙标记连接）
  - 根据iptables的标记进行路由，可以实现分组的效果

## 高可用集群

LVS自身没有后端服务器健康状态检查功能，且LVS自身需要高可用

- Keepalive
  - Keepalive是为高可用设计的软件
  - 支持节点健康检查(Health Check)
  - 支持故障自动切换(Failover)
  - 使用VRRP(Virtual Router Redundancy Protocol，虚拟路由冗余协议)
    - 一主多备，公用同一个IP地址，优先级不同。类似于弹性IP
    - 很多路由器实现高可用的时候也只用此协议
  - 通常和LVS-DR一起使用实现4层高可用
- Heartbeat
  - 经常和Nginx结合使用，实现7层负载均衡的高可用



