---
title: Linux Basic (part 8)
description: 进程管理、后台任务管理、定时任务等
tags:
  - linux
  - ops
---

## 前言

本文是观看[此视频](https://www.bilibili.com/video/bv1ut411a7ro)时整理的笔记，只记录了我觉得有价值的内容，用来查阅而不是用来学习。不一定适合小白入门Linux。

本文中的Linux系统为CentOS，不同系统在一些细节上会有偏差

本文中的一些描述混合了我的奇妙理解，添加了一些云计算相关知识

有些内容与[大学的笔记](/academic/LinuxProgrammingEnvironment/)重复，建议先看大学的笔记

## 系统管理

### 进程管理

- `ps`查看系统进程。此命令的部分选项不能加`-`，这是老式BSD系统的格式
  - `a`显示一个终端的所有进程，除了会话阴险
  - `u`显示进程的归属用户与内存使用情况
  - `x`显示没有控制终端的进程
  - `ps aux`查看系统所有进程
    - 输出格式
      - `VSZ`占用虚拟内存的大小，单位KB
      - `RSS`占用物理内存的大小，单位KB
      - `TTY`进程在哪个终端
        - `tty1-6`是本地字符终端
        - `tty7`是本地图形终端
        - `pts/0-255`是虚拟终端
        - `?`内核生成的系统进程，不需要终端号
      - `STAT`进程状态
      - `START`进程启动的时间，`hh:mm`
      - `TIME`耗费的CPU时间，`hh:mm`
  - `ps -le`类似于`ps aux`，只不过输出的进程命令为简写
- `top`动态查看进程
  - 3秒刷新一次，按照CPU占用率排序
  - 输出内容
    - 系统当前时间
    - 系统运行了多久
    - 用户数
    - **1/5/15分钟平均CPU负载**。通常不建议超过CPU核心数
    - 进程统计信息
    - CPU统计信息
      - 用户模式占用的CPU百分比
      - 系统模式占用的CPU
      - 改变过优先级的用户进程占用的CPU
      - **空闲CPU占比**
      - 等待IO的进程的CPU占比
      - 硬中断请求服务占用的CPU
      - 软中断请求服务占用的CPU
      - 虚拟时间(steal time)百分比
    - 内存统计
    - swap统计
  - 交互模式命令
    - `?`/`h`查看帮助。按任意键退出
    - `P`以CPU利用率排序（默认）
    - `M`以内存占用排序
    - `N`以PID排序
    - `T`以CPU累计运算时间排序
    - `k`用来终止进程
    - `r`给进程重设优先级
    - `q`退出
  - 选项
  - `-d <second>`指定刷新间隔（秒）
  - `-b`批处理模式输出而不是动态刷新。通常和`-n`组合使用
  - `-n <times>`指定执行次数
  - `-p <pid>`指定PID，仅查看某个PID的进程
  - `-s`使此命令在安全模式运行，避免交互模式中出现误操作
  - `-u <username>`仅监听某个用户的进程
- `pstree`查看进程依赖关系
  - `-p`显示PID
  - `-u`显示进程所属用户
- `kill`结束进程
  - `kill -l`查看`kill`支持的信号
  - 常见信号
    - `-1`立即关闭进程，重新读取配置文件后重启
    - `-9`立即结束程序。此信号不能被阻塞、处理和忽略。用来强制杀死进程
  - `kill [signal] <PID>`给进程发送信号
- `killall [options] [signal] <p-name>`根据进程名杀死进程
  - `-i`交互式
  - `-I`忽略进程名大小写
- `pkill [signal] [options] <p-name>`根据进程名杀死进程。常用于踢出用户
  - `-t <tty>`根据终端号踢出用户
  - `pkill -9 -t pts/1`强制杀死从`pts/1`登录的进程

### 后台进程管理

#### 概述

当前终端只能管理当前终端的程序。终端关闭时后台程序也会退出

#### 命令

- `<command> &`把命令放入后台运行
- 在命令执行过程中按`Ctrl+Z`，暂停应用并放到后台
- `jobs`查看后台进程
  - 输出的第一列不是PID，而是job ID
  - `-l`输出PID
- `fg %<job-id>`把后台进程放到前台
  - `%`可以省略
- `bg %<job-id>`把后台暂停的工作设置为执行
- `nohup [command] &`使命令脱离终端执行

### 系统资源管理

命令：
- `vmstat [refresh-latency refresh-count]`查看系统资源
  - `vmstat 1 3`每秒刷新一次，一共刷新三次
  - 输出格式
    - 进程信息
      - `r`等待运行的进程数。数值越大，系统越繁忙
      - `b`不可唤醒的进程数量。数值越大，系统越繁忙
    - 内存信息
      - `swpd`虚拟内存使用情况（KB）
      - ...
    - `swap`使用情况
      - `si`磁盘到内存的数据量（KB）
      - `so`内存到磁盘的数据框（KB）
    - IO情况
      - `bi`从块设备读入的数据总量，单位是块
      - `bo`
    - 系统状态
      - `in`每秒被中断的次数
      - `cs`每秒钟进行的事件切换次数
    - CPU状态
- `dmesg`显示开机时的内核监测信息
  - `dmesg | grep GPU`查看CPU信息
  - `dmesg | grep eth0`查看第一块网卡的信息
- `free [options]`查看内存状态
  - `-b`单位为字节
  - `-k`单位为KB（默认）
  - `-m`单位为MB
  - `-g`单位为GB
  - `-h`人性化显示
- `uptime`查看系统启动时间和平均负载，即`top`命令的第一行
- `uname [options]`查看内核相关信息
  - `-a`查看所有信息
  - `-r`查看内核版本
  - `-s`查看内核名称
- `file /bin/ls`通过查看系统命令的信息查看系统的位数
- `lsb_release -a`查看当前Linux系统的发行版本

文件：
- `/proc/cpuinfo`
- `/proc/meminfo`

## 定时任务

### 一次性任务

启动`at`服务：`service atd start`。默认状态下`at`应该为启动的状态

访问控制文件：
- `/etc/at.allow`白名单文件
  - 默认此文件不存在
  - 如果此文件存在，则只有此文件中的用户可以使用`at`。一个用户名一行
- `/etc/at.deny`黑名单文件
  - 默认此文件不存在
  - 如果白名单文件存在，此文件不生效
  - 如果白名单文件不存在而此文件存在，则除了此文件内的用户，其他用户都可以使用`at`
  - 对`root`用户不生效
- 没有黑白名单文件时，只有`root`用户可以使用`at`

使用方式：`at [options] <time>`
- `-m`工作完成后无论命令是否有输出都邮件通知执行`at`命令的用户
- `-c <job-id>`显示`at`工作的实际内容
- 支持的`time`格式
  - `hh:mm`
  - `hh:mm yyyy-mm-dd`
  - `hh:mm[ap|pm] [month] [date]`
  - `hh:mm[am|pm] + [min|hours|days|weeks]`
- 执行`at`后输入要定时执行的命令

其他命令：
- `atq`查询任务，但是只能查job ID和用户，查不到命令
- `atrm [job-id]`删除任务

### 周期性任务

启动`cron`服务：`service crond start`。默认状态下`cron`应该为启动的状态

访问控制文件：
- `/etc/cron.allow`白名单
  - 默认不存在
  - 如果此文件存在，只有此文件中的用户可以使用`cron`
- `/etc/cron.deny`黑名单
  - 类似`/etc/at.deny`

命令：
- `crontab [options]`
  - `-e`编辑定时任务
  - `-l`查询任务
  - `-r`删除当前用户的所有任务
  - `-u <username>`修改或删除其他用户的任务。仅root用户可用
  - 使用此命令设置的任务会使用当前用户执行
- `/usr/bin/run-parts`执行某个目录下的所有文件

通常会直接修改`crontab`配置文件而不是使用命令

配置文件`/etc/crontab`：
- 内容
  - 每小时的第几分钟（0-59）
  - 每天的第几小时（0-23）
  - 每月的第几天（1-31）
  - 每年的地几个月(1-21)
  - 每周的周几（0-7，0和7都是周日）
  - 用户名
  - 命令。最好使用绝对路径，防止`PATH`出问题
- 特殊符号
  - `*`表示任意时间
  - `,`表示不连续的时间，比如`1,2,3,4,5`
  - `-`表示连续的范围，比如`1-6`
  - `*/n`表示每隔多久执行一次
    - 比如每小时的第几分钟的值为`*/10`则表示10分钟一次

【周几】和【每个月的第几天】最好不要同时出现。他们都是在定义【日】，而且是【或】的关系而不是【与】的关系

### 关机定时任务

如果定时任务需要执行时系统处于关机状态而错过执行，`anacron`会在下次启动后自行寻找时间执行错过的命令

配置文件：
- `/etc/anacrontab`保存定时任务信息
  - 随机延迟：防止多个任务同时执行导致服务器过载
- `/var/spool/anacron/`里面的文件保存了定时任务上次执行的时间

> 旧版本中，`/etc/cron.daily`等文件会被`cron`和`anacron`调用，可能出问题。新版本中`/etc/cron.daily`等文件只会被`anacron`调用 

