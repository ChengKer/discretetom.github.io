(window.webpackJsonp=window.webpackJsonp||[]).push([[123],{1135:function(t,n){const o={render:function(){this.$createElement;return this._self._c,this._m(0)},staticRenderFns:[function(){var t=this,n=t.$createElement,o=t._self._c||n;return o("div",{staticClass:"frontmatter-markdown"},[o("h2",{attrs:{id:"tcp-udp"}},[t._v("TCP & UDP")]),t._v(" "),o("ul",[o("li",[t._v("TCP\n"),o("ul",[o("li",[t._v("面向连接")]),t._v(" "),o("li",[t._v("可靠")]),t._v(" "),o("li",[t._v("字节流传输")]),t._v(" "),o("li",[t._v("不保证报文边界")])])]),t._v(" "),o("li",[t._v("UDP\n"),o("ul",[o("li",[t._v("面向数据报")]),t._v(" "),o("li",[t._v("不可靠\n"),o("ul",[o("li",[t._v("可能存在错包、丢包、重包、乱序，需要流量控制")])])]),t._v(" "),o("li",[t._v("数据报传输")]),t._v(" "),o("li",[t._v("可以广播和组播")])])])]),t._v(" "),o("h2",{attrs:{id:"网络字节序"}},[t._v("网络字节序")]),t._v(" "),o("p",[t._v("可以参考"),o("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2016/11/byte-order.html"}},[t._v("阮一峰的文章")])]),t._v(" "),o("h3",{attrs:{id:"cpu字节顺序"}},[t._v("CPU字节顺序")]),t._v(" "),o("ul",[o("li",[t._v("Big Endian(大端序，大尾)\n"),o("ul",[o("li",[t._v("PowerPC")]),t._v(" "),o("li",[t._v("Motorola")])])]),t._v(" "),o("li",[t._v("Little Endian（小端序，小尾）\n"),o("ul",[o("li",[t._v("Intel x86")])])])]),t._v(" "),o("p",[t._v("应用场景：")]),t._v(" "),o("ul",[o("li",[t._v("大端序适合人类读写")]),t._v(" "),o("li",[t._v("小端序在计算机计算时较为高效")])]),t._v(" "),o("p",[t._v("所以只有在计算机内部保存的时候使用小端序，其他人类需要读的地方都使用大端序")]),t._v(" "),o("p",[t._v("因此"),o("strong",[t._v("网络字节顺序也是大端序")])]),t._v(" "),o("h3",{attrs:{id:"网络字节处理库函数"}},[t._v("网络字节处理库函数")]),t._v(" "),o("p",[t._v("因为计算机内保存数字的字节序不同，所以把数字转为字节的时候需要转换函数来保证转换结果是大端序")]),t._v(" "),o("ul",[o("li",[t._v("四字节整数(long)\n"),o("ul",[o("li",[o("code",{pre:!0},[t._v("htonl")]),t._v(" - host to net long")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("ntohl")]),t._v(" - net to host long")])])]),t._v(" "),o("li",[t._v("两字节整数(short)\n"),o("ul",[o("li",[o("code",{pre:!0},[t._v("htons")]),t._v(" - host to net short")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("ntohs")]),t._v(" - net to host short")])])])]),t._v(" "),o("h2",{attrs:{id:"socket"}},[t._v("SOCKET")]),t._v(" "),o("h3",{attrs:{id:"readwrite"}},[t._v("read/write")]),t._v(" "),o("ul",[o("li",[t._v("服务器read后进程阻塞")]),t._v(" "),o("li",[t._v("客户端write之后把数据发送到缓冲区，然后发往服务器")]),t._v(" "),o("li",[t._v("服务器回复ACK。如果ACK丢了，客户端重发，服务器收到后丢掉并回复ACK")])]),t._v(" "),o("p",[t._v("除了read/write还有其他类似函数，比如recv/send或recvfrom/sendto")]),t._v(" "),o("p",[t._v("recvfrom/sendto可以指定对方端点名，常用于UDP")]),t._v(" "),o("p",[t._v("windows下只能用recv/send")]),t._v(" "),o("h3",{attrs:{id:"keepalive"}},[t._v("keepalive")]),t._v(" "),o("p",[t._v("可以使用getsockopt/setsockopt设置TCP keepalive（默认2小时）")]),t._v(" "),o("h3",{attrs:{id:"获得端点名"}},[t._v("获得端点名")]),t._v(" "),o("p",[o("code",{pre:!0},[t._v("getpeername(int sockfd, struct sockaddr *name, int *namelen)")]),t._v("获取对方端点名")]),t._v(" "),o("p",[o("code",{pre:!0},[t._v("getsockname(int sockfd, struct sockaddr *name, int *namelen)")]),t._v("获取本地端点名")]),t._v(" "),o("h3",{attrs:{id:"使用shutdown关闭半个连接"}},[t._v("使用shutdown关闭半个连接")]),t._v(" "),o("p",[o("code",{pre:!0},[t._v("int shutdown(int sockfd, int howto)")])]),t._v(" "),o("p",[t._v("禁止发送或接受。默认socket是提供全双工通信的，shutdown可以关闭一个方向")]),t._v(" "),o("p",[t._v("参数"),o("code",{pre:!0},[t._v("howto")]),t._v("的取值：")]),t._v(" "),o("ul",[o("li",[o("code",{pre:!0},[t._v("SHUT_RD")]),t._v(" - 禁止读，每次read返回0")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("SHUT_WR")]),t._v(" - 禁止写，每次write导致SIGPIPE信号")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("SHUT_RDWR")]),t._v(" - 上述二者效果之和")])]),t._v(" "),o("p",[t._v("TCP协议下，禁止读会告诉对方自己的接收窗口大小为0。对方会继续写，并把数据堆积在缓冲区")]),t._v(" "),o("p",[t._v("UDP下仅使自己不能读，但是不能阻止对方发送。即使socket关闭也不影响对方发出无人接收的数据报")]),t._v(" "),o("h3",{attrs:{id:"控制socket"}},[t._v("控制socket")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("getsockopt")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" sokfd"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" level"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" optname"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("void")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("*")]),t._v("optval"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("*")]),t._v("optlen"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("setsockopt")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" sockfd"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" level"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" optname"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("void")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("*")]),t._v("optval"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" optlen"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("ioctl")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" fd"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" cmd"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("void")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("*")]),t._v("arg"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n")])]),t._v(" "),o("h3",{attrs:{id:"bind函数"}},[t._v("bind函数")]),t._v(" "),o("p",[t._v("bind调用的目的是指定一个网络连接的"),o("strong",[t._v("本地端点名")]),t._v("。客户端程序一般不使用bind调用，操作系统自动为socket分配本地IP地址和本地TCP端口号。如果本计算机有多个IP地址，客户要求必须使用其中的某个地址，或者，客户需要指定本地端口号，那么就需要用bind调用，然后再执行connect调用。")]),t._v(" "),o("h2",{attrs:{id:"tcp客户端-服务器程序"}},[t._v("TCP客户端-服务器程序")]),t._v(" "),o("h3",{attrs:{id:"客户端程序"}},[t._v("客户端程序")]),t._v(" "),o("p",[t._v("流程：")]),t._v(" "),o("ol",[o("li",[t._v("创建文件描述符socket")]),t._v(" "),o("li",[t._v("建立连接connect，进程阻塞，等待三次握手成功")]),t._v(" "),o("li",[t._v("发送数据。如果发送速率大于通信速率，进程会被阻塞")]),t._v(" "),o("li",[t._v("关闭连接")])]),t._v(" "),o("p",[o("strong",[t._v("端点名")]),t._v(" - IP地址+端口号。有本地端点名和远端端点名")]),t._v(" "),o("p",[t._v("示例程序：")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token macro property"},[t._v("#"),o("span",{staticClass:"token directive keyword"},[t._v("define")]),t._v(" SIZE 8192")]),t._v("\n"),o("span",{staticClass:"token macro property"},[t._v("#"),o("span",{staticClass:"token directive keyword"},[t._v("define")]),t._v(" PORT_NO 12345")]),t._v("\n\n"),o("span",{staticClass:"token comment"},[t._v("// argv[1] is the host IP address")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" argc"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&&")]),t._v(" argv"),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" len"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" name"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("unsigned")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" sbuf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),t._v("SIZE"),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\n\t"),o("span",{staticClass:"token comment"},[t._v("// init socket")]),t._v("\n\tsock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("socket")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SOCK_STREAM"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" "),o("span",{staticClass:"token comment"},[t._v("// error handling")]),t._v("\n\t\n\t"),o("span",{staticClass:"token comment"},[t._v("// construct host address")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_family "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("s_addr "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htonl")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("inet_network")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("argv"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htons")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("PORT_NO"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\t"),o("span",{staticClass:"token comment"},[t._v("// connect")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("connect")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"\\nconnecting server stream socket"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Connected.\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\t"),o("span",{staticClass:"token comment"},[t._v("// send data from stdin")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("while")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("fgets")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sbuf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SIZE"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token constant"},[t._v("stdin")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token constant"},[t._v("NULL")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("break")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("write")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" sbuf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("strlen")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sbuf"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"sending stream message"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\n\t"),o("span",{staticClass:"token comment"},[t._v("// close connection")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Connection closed.\\n\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n")])]),t._v(" "),o("h3",{attrs:{id:"服务端程序"}},[t._v("服务端程序")]),t._v(" "),o("p",[t._v("流程：")]),t._v(" "),o("ol",[o("li",[t._v("创建文件描述符socket")]),t._v(" "),o("li",[t._v("使用bind设定本地端点名（也可以在客户端用")]),t._v(" "),o("li",[t._v("使用listen告诉系统内核socket已经开始监听")]),t._v(" "),o("li",[t._v("程序会阻塞在accept等待连接")])]),t._v(" "),o("p",[t._v("示例程序：")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token macro property"},[t._v("#"),o("span",{staticClass:"token directive keyword"},[t._v("define")]),t._v(" PORT_NO 12345")]),t._v("\n\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" data_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" nbyte"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" i"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" name"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("8192")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\n\tadmin_sock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("socket")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SOCK_STREAM"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_family "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("s_addr "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" INADDR_ANY"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htons")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("PORT_NO"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\t"),o("span",{staticClass:"token function"},[t._v("bind")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("listen")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("5")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\tdata_sock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("accept")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"accept connection\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\t"),o("span",{staticClass:"token keyword"},[t._v("while")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\tnbyte "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("read")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("data_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("buf"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("nbyte "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Disconnected.\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("data_sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("i "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" i "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" nbyte"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("++")]),t._v("i"),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"%c"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),t._v("i"),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n")])]),t._v(" "),o("p",[t._v("SOCKET服务器的问题：不能同时容纳多个连接")]),t._v(" "),o("p",[t._v("解决方案：")]),t._v(" "),o("ul",[o("li",[t._v("多进程并发处理")]),t._v(" "),o("li",[t._v("单进程并发处理")])]),t._v(" "),o("h2",{attrs:{id:"多进程并发服务端"}},[t._v("多进程并发服务端")]),t._v(" "),o("p",[t._v("示例代码：")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token comment"},[t._v("// ======================================== server1.c")]),t._v("\n"),o("span",{staticClass:"token macro property"},[t._v("#"),o("span",{staticClass:"token directive keyword"},[t._v("define")]),t._v(" PORT_NO 12345")]),t._v("\n\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" data_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" pid"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" name_len"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" peer"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\n\tadmin_sock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("socket")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SOCK_STREAM"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"create stream socket"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_family "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("s_addr "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" INADDR_ANY"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htons")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("PORT_NO"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("bind")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"binding stream socket"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("listen")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("5")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("signal")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("SIGCLD"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SIG_IGN"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\t"),o("span",{staticClass:"token keyword"},[t._v("while")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\tname_len "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\tdata_sock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("accept")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name_len"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("data_sock "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("continue")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Accept connection from %s:%d\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("inet_ntoa")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("ntohs")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\n\t\tpid "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("fork")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("pid "),o("span",{staticClass:"token operator"},[t._v(">")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t"),o("span",{staticClass:"token comment"},[t._v("// parent process")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("data_sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("else")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("pid "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t"),o("span",{staticClass:"token comment"},[t._v("// child process")]),t._v("\n\t\t\t"),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" fd_str"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("16")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("sprintf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd_str"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token string"},[t._v('"%d"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" data_sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("execlp")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"./server1a"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token string"},[t._v('"./server1a"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" fd_str"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"execlp"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\n"),o("span",{staticClass:"token comment"},[t._v("// ================================================ server1a.c")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" argc"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("*")]),o("span",{staticClass:"token operator"},[t._v("*")]),t._v(" argv"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" peer"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("unsigned")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("8192")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" nbyte"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" i"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" name_len "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tsock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("strtol")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("argv"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("getpeername")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("buf"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"%s:%d"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("inet_ntoa")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("ntohs")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("nbyte "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Receiving packet"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("else")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("nbyte "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Disconnected.\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("i "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" i "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" nbyte"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("++")]),t._v("i"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"%c"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),t._v("i"),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n")])]),t._v(" "),o("p",[t._v("主进程中的"),o("code",{pre:!0},[t._v("signal(SIGCLD, SIG_IGN);")]),t._v("表示子进程结束后不需要父进程收尸而直接释放资源。这样父进程不需要wait也可以避免僵尸进程的产生")]),t._v(" "),o("h2",{attrs:{id:"单进程并发处理"}},[t._v("单进程并发处理")]),t._v(" "),o("h3",{attrs:{id:"select实现多路io"}},[t._v("select实现多路IO")]),t._v(" "),o("p",[o("code",{pre:!0},[t._v("int select(int maxfdp1, fd_set *rfds, fd_set *wfds, fd_set *efds, struct timeval *timeout)")])]),t._v(" "),o("p",[t._v("select使得用户进程可以同时等待多个事件。如果事件发生则select返回，否则进程睡眠等待")]),t._v(" "),o("p",[t._v("集合参数：")]),t._v(" "),o("ul",[o("li",[o("code",{pre:!0},[t._v("rfds")]),t._v(" - 这些文件描述符如果发生"),o("strong",[t._v("读")]),t._v("事件则返回\n"),o("ul",[o("li",[t._v("即read这些文件不会阻塞")])])]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("wfds")]),t._v(" - 这些文件描述符如果发生"),o("strong",[t._v("写")]),t._v("事件则返回\n"),o("ul",[o("li",[t._v("即write这些文件不会阻塞")])])]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("efds")]),t._v(" - 这些文件描述符如果发生"),o("strong",[t._v("异常")]),t._v("事件则返回\n"),o("ul",[o("li",[t._v("TCP连接中，只有"),o("strong",[t._v("加急数据")]),t._v("算是异常情况。"),o("strong",[t._v("对方连接关闭或网络故障不算异常情况")])])])])]),t._v(" "),o("p",[t._v("集合参数可以为NULL。集合参数在函数内部可能被修改")]),t._v(" "),o("h3",{attrs:{id:"集合操作"}},[t._v("集合操作")]),t._v(" "),o("p",[t._v("数据类型"),o("code",{pre:!0},[t._v("fd_set")]),t._v("（在C语言头文件定义")]),t._v(" "),o("ul",[o("li",[o("code",{pre:!0},[t._v("void FD_ZERO(fd_set *fds)")]),t._v(" - 清空指定集合")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("void FD_SET(int fd, fd_set *fds)")]),t._v(" - 把fd加到fds里面")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("void FD_CLR(int fd, fd_set *fds)")]),t._v(" - 把fd从fds里面删除")]),t._v(" "),o("li",[o("code",{pre:!0},[t._v("int FD_ISSET(int fd, fd_set *fds)")]),t._v(" - 判断fd是否在fds中")])]),t._v(" "),o("h3",{attrs:{id:"超时时间"}},[t._v("超时时间")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("timeval")]),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("long")]),t._v(" tv_sec"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" "),o("span",{staticClass:"token comment"},[t._v("// second")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("long")]),t._v(" tv_usec"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" "),o("span",{staticClass:"token comment"},[t._v("// microsecond, 1e-9")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n")])]),t._v(" "),o("p",[t._v("select的最后一个参数timeout")]),t._v(" "),o("ul",[o("li",[t._v("如果不为0，则超时会返回。受限于硬件，通常精度为10毫秒级别")]),t._v(" "),o("li",[t._v("如果为0，则立即返回（无阻塞方式查询")]),t._v(" "),o("li",[t._v("如果是空指针NULL，则无超时时间，无限等待")])]),t._v(" "),o("h3",{attrs:{id:"代码"}},[t._v("代码")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token macro property"},[t._v("#"),o("span",{staticClass:"token directive keyword"},[t._v("define")]),t._v(" PORT_NO 12345")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("void")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" data_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" ret"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" maxfdp1"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" fd"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" name"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tfd_set fds"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" rfds"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tadmin_sock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("socket")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SOCK_STREAM"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_family "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("s_addr "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" INADDR_ANY"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htons")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("PORT_NO"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("bind")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"bind"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("listen")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("5")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"ready\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tmaxfdp1 "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" admin_sock "),o("span",{staticClass:"token operator"},[t._v("+")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("FD_ZERO")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("fds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("FD_SET")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("fds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("memcpy")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("rfds"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("fds"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\tret "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("select")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("n"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("rfds"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("FD_ISSET")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("rfds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\tdata_sock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("accept")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("admin_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("data_sock "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t\t"),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("FD_SET")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("data_sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("fds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("n "),o("span",{staticClass:"token operator"},[t._v("<=")]),t._v(" data_sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t\tn "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" data_sock "),o("span",{staticClass:"token operator"},[t._v("+")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" fd "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" n"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" fd"),o("span",{staticClass:"token operator"},[t._v("++")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd "),o("span",{staticClass:"token operator"},[t._v("!=")]),t._v(" admin_sock "),o("span",{staticClass:"token operator"},[t._v("&&")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("FD_ISSET")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("rfds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("receive_data")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd"),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t\t\t\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t\t\t"),o("span",{staticClass:"token function"},[t._v("FD_CLR")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("fd"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("fds"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("receive_data")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("unsigned")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" rbuf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("8192")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" peer"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" i"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" nbyte"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" name_len "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tnbyte "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("recvfrom")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" rbuf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SIZE"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name_len"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("nbyte "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"receiving stream packet"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("return")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"%s:%d "')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("inet_ntoa")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("ntohs")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("peer"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("nbyte "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"*** Disconnected.\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("return")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("i "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" i "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" nbyte"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v(" i"),o("span",{staticClass:"token operator"},[t._v("++")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"%c"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" rbuf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),t._v("i"),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("return")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n")])]),t._v(" "),o("h2",{attrs:{id:"udp通信"}},[t._v("UDP通信")]),t._v(" "),o("h3",{attrs:{id:"客户端"}},[t._v("客户端")]),t._v(" "),o("ul",[o("li",[t._v("connect\n"),o("ul",[o("li",[t._v("不产生网络流量，内核记下远端端点名")]),t._v(" "),o("li",[t._v("如果之前没有使用bind指定本地端点名，则系统自动分配本地端点名")])])]),t._v(" "),o("li",[t._v("write\n"),o("ul",[o("li",[t._v("使用前面connect调用时指定的端点名")]),t._v(" "),o("li",[t._v("UDP不面向连接，可以在sendto函数的参数中指定对方端点名，允许对方端点名不同")]),t._v(" "),o("li",[t._v("每次都使用sendto发送数据的话就不需要connect了")]),t._v(" "),o("li",[t._v("在获得本地端点名之前不应该执行read或recv或recvfrom")])])])]),t._v(" "),o("p",[t._v("示例代码：")]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token macro property"},[t._v("#"),o("span",{staticClass:"token directive keyword"},[t._v("define")]),t._v(" PORT_NO 12345")]),t._v("\n"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" argc"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("*")]),t._v("argv"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" len"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" name"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" sbuf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("8192")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("argc "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("2")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t"),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tsock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("socket")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SOCK_DGRAM"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_family "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("s_addr "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htonl")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("inet_network")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("argv"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htons")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("PORT_NO"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("connect")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("fgets")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sbuf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),t._v(" sbuf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token constant"},[t._v("stdin")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("==")]),t._v(" "),o("span",{staticClass:"token constant"},[t._v("NULL")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t"),o("span",{staticClass:"token keyword"},[t._v("break")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\tlen "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("write")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" sbuf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("strlen")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sbuf"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("len "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t"),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(".")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"send %d bytes\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" len"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token function"},[t._v("close")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n")])]),t._v(" "),o("h3",{attrs:{id:"服务端程序-2"}},[t._v("服务端程序")]),t._v(" "),o("ul",[o("li",[t._v("接收\n"),o("ul",[o("li",[t._v("没有数据到达时read会睡眠")]),t._v(" "),o("li",[t._v("通常需要区分数据来源。使用recvfrom获得对方端点名")])])]),t._v(" "),o("li",[t._v("发送\n"),o("ul",[o("li",[t._v("服务端使用sendto来指定对方端点名")])])]),t._v(" "),o("li",[t._v("select定时\n"),o("ul",[o("li",[t._v("使用select可以实现同时等待多个事件，包括得到数据和定时器超时")])])])]),t._v(" "),o("pre",{staticClass:"language-cpp"},[o("code",{staticClass:"language-cpp"},[o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("main")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token keyword"},[t._v("void")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("int")]),t._v(" sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" len"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("struct")]),t._v(" "),o("span",{staticClass:"token class-name"},[t._v("sockaddr_in")]),t._v(" name"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("unsigned")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("char")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v("[")]),o("span",{staticClass:"token number"},[t._v("8192")]),o("span",{staticClass:"token punctuation"},[t._v("]")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tsock "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("socket")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" SOCK_DGRAM"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_family "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" AF_INET"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_addr"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("s_addr "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" INADDR_ANY"),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\tname"),o("span",{staticClass:"token punctuation"},[t._v(".")]),t._v("sin_port "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("htons")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("12345")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token function"},[t._v("bind")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("&")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("name"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v(" "),o("span",{staticClass:"token operator"},[t._v("<")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("perror")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"binding socket"')]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token function"},[t._v("exit")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token number"},[t._v("1")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n\t"),o("span",{staticClass:"token keyword"},[t._v("for")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("{")]),t._v("\n\t\tlen "),o("span",{staticClass:"token operator"},[t._v("=")]),t._v(" "),o("span",{staticClass:"token function"},[t._v("read")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("sock"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" "),o("span",{staticClass:"token keyword"},[t._v("sizeof")]),t._v(" buf"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t\t"),o("span",{staticClass:"token keyword"},[t._v("if")]),t._v(" "),o("span",{staticClass:"token punctuation"},[t._v("(")]),t._v("len "),o("span",{staticClass:"token operator"},[t._v(">")]),t._v(" "),o("span",{staticClass:"token number"},[t._v("0")]),o("span",{staticClass:"token punctuation"},[t._v(")")]),t._v("\n\t\t\t"),o("span",{staticClass:"token function"},[t._v("printf")]),o("span",{staticClass:"token punctuation"},[t._v("(")]),o("span",{staticClass:"token string"},[t._v('"Receive %d bytes\\n"')]),o("span",{staticClass:"token punctuation"},[t._v(",")]),t._v(" len"),o("span",{staticClass:"token punctuation"},[t._v(")")]),o("span",{staticClass:"token punctuation"},[t._v(";")]),t._v("\n\t"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n"),o("span",{staticClass:"token punctuation"},[t._v("}")]),t._v("\n")])])])}]};t.exports={attributes:{layout:"collection",title:"网络程序设计",collection:"LinuxProgrammingEnvironment"},vue:{render:o.render,staticRenderFns:o.staticRenderFns,component:{data:function(){return{templateRender:null}},render:function(t){return this.templateRender?this.templateRender():t("div","Rendering")},created:function(){this.templateRender=o.render,this.$options.staticRenderFns=o.staticRenderFns}}}}}}]);